# Custom values for the zot Helm chart
# Values placed under the 'zot:' key will be passed to the subchart.
zot:
  # Use the multi-arch image instead of the AMD64-specific one
  image:
    # use zot multi-arch image
    repository: ghcr.io/project-zot/zot
    tag: "v2.1.4"

  # Ensure zot runs on AMD64 nodes (or use ARM64 image instead)
  # nodeSelector:
  #   kubernetes.io/arch: amd64

  # Enable debug logging and access logs
  env:
  - name: ZOT_LOG_LEVEL
    value: "debug"
  # Mount only the config.json key from the secret to the specific file
  extraVolumes:
  - name: zot-config-volume
    secret:
      secretName: zot-config
      items:
      - key: config.json
        path: config.json
  - name: zot-sync-volume
    emptyDir: {}

  extraVolumeMounts:
  - name: zot-config-volume
    mountPath: /etc/zot/config.json
    subPath: config.json
    readOnly: true
  - name: zot-sync-volume
    mountPath: /tmp/zot-sync
    readOnly: false
  # Service configuration
  service:
    type: ClusterIP
    port: 5000
    annotations:
      # Configure service timeout for large uploads
      service.beta.kubernetes.io/timeout: "3600"

  # Configure ingress for zot
  ingress:
    enabled: true
    className: traefik
    annotations:
      # Use Traefik's websecure entrypoint for HTTPS
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      # Enable TLS termination at the router (Traefik handles certs)
      traefik.ingress.kubernetes.io/router.tls: "true"
      # Increase body size limit and disable buffering
      # traefik.ingress.kubernetes.io/router.middlewares: services-zot-registry@kubernetescrd
    hosts:
    - host: zot.cloudfleet.platform.5ha.re
      paths:
      - path: /
        pathType: Prefix
    tls:
    - hosts:
      - zot.cloudfleet.platform.5ha.re
      secretName: zot-tls

  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
